<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>リンクINDEX</title>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 24px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .muted { opacity:.7; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .card { border:1px solid #ddd; border-radius:12px; padding:14px; margin:12px 0; }
    .grid { display:grid; grid-template-columns: 1fr; gap:10px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1fr 1fr; } }
    input, select, button { padding:10px; border-radius:10px; border:1px solid #ccc; }
    button { cursor:pointer; }
    .tag { display:inline-block; padding:2px 10px; border:1px solid #ccc; border-radius:999px; font-size:12px; margin-left:8px; }
    .item { border:1px solid #eee; border-radius:12px; padding:12px; }
    .item h3 { margin:0 0 6px; font-size:16px; }
    .item a { text-decoration:none; }
    .item small { display:block; margin-top:6px; }
    .admin { background:#fafafa; }
    .hidden { display:none; }
  </style>
</head>

<body>
<header>
  <div>
    <h1 style="margin:0;">リンクINDEX</h1>
    <div class="muted">ディレクトリ配下のリンクを自動収集して表示します</div>
  </div>
  <div class="row">
    <input id="q" placeholder="検索（タイトル/パス）" />
    <select id="catFilter">
      <option value="">カテゴリ（すべて）</option>
    </select>
    <button id="reloadBtn">再読み込み</button>
    <button id="loginBtn">管理者ログイン</button>
    <button id="logoutBtn" class="hidden">ログアウト</button>
  </div>
</header>

<section class="card">
  <div class="row">
    <span class="muted">取得元:</span>
    <code id="sourceLabel"></code>
    <span class="muted">件数:</span>
    <strong id="countLabel">-</strong>
    <span class="muted">最終更新:</span>
    <span id="updatedLabel">-</span>
  </div>
</section>

<section id="adminPanel" class="card admin hidden">
  <h2>管理者パネル</h2>

  <div id="loginBox">
    <div class="row">
      <input id="email" type="email" placeholder="email">
      <input id="pass" type="password" placeholder="password">
      <button id="doLogin">ログイン</button>
    </div>
    <div id="authMsg" class="muted"></div>
  </div>

  <div id="editorBox" class="hidden">
    <div class="muted">ログイン中: <span id="userLabel"></span></div>
  </div>
</section>

<section id="list" class="grid"></section>

<script type="module">
/* ========= 設定 ========= */
const CFG = {
  github: {
    owner: "DrPotter2022",
    repo: "call-link-test",
    branch: "main",
    path: "",
    includeExt: [".html", ".pdf"],
    siteBaseUrl: "https://YOURNAME.github.io/YOUR_GITHUB_REPO/"
  },
  firebase: {
    apiKey: "AIzaSyCJV2CDJl9NW6Qz3sbPd8nrV0zevzZam0I",
    authDomain: "index-6c554.firebaseapp.com",
    projectId: "index-6c554"
  },
  collection: "link_index_meta_v1"
};

/* ========= Firebase ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const app = initializeApp(CFG.firebase);
const auth = getAuth(app);
const db = getFirestore(app);

/* ========= DOM ========= */
const el = id => document.getElementById(id);
const listEl = el("list");
el("sourceLabel").textContent = `github:${CFG.github.owner}/${CFG.github.repo}/${CFG.github.path}`;

/* ========= GitHub ========= */
async function fetchGitHubTree() {
  const { owner, repo, branch } = CFG.github;
  const ref = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/ref/heads/${branch}`).then(r=>r.json());
  const commit = await fetch(ref.object.url).then(r=>r.json());
  const tree = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/${commit.tree.sha}?recursive=1`).then(r=>r.json());
  return tree.tree.filter(x => x.type==="blob" && x.path.startsWith(CFG.github.path));
}

/* ========= 初期表示 ========= */
async function loadAll() {
  const files = await fetchGitHubTree();
  listEl.innerHTML = files.map(f =>
    `<div class="item">
      <h3><a href="${CFG.github.siteBaseUrl}${f.path}" target="_blank">${f.path.split("/").pop()}</a></h3>
      <small class="muted">${f.path}</small>
    </div>`
  ).join("");
  el("countLabel").textContent = files.length;
  el("updatedLabel").textContent = new Date().toLocaleString("ja-JP");
}

loadAll();

/* ========= Auth ========= */
el("doLogin").onclick = async () => {
  try {
    await signInWithEmailAndPassword(auth, el("email").value, el("pass").value);
  } catch(e) {
    el("authMsg").textContent = e.message;
  }
};

onAuthStateChanged(auth, user => {
  if (user) {
    el("loginBox").classList.add("hidden");
    el("editorBox").classList.remove("hidden");
    el("userLabel").textContent = user.email;
    el("logoutBtn").classList.remove("hidden");
  }
});

el("logoutBtn").onclick = () => signOut(auth);
</script>

</body>
</html>
