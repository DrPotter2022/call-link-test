<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>リンクINDEX</title>
  <link rel="icon" href="data:,">
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 24px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .muted { opacity:.75; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .card { border:1px solid #ddd; border-radius:12px; padding:14px; margin:12px 0; }
    .danger { border-color:#e7b3b3; background:#fff7f7; }
    .grid { display:grid; grid-template-columns: 1fr; gap:10px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1fr 1fr; } }
    input, select, button { padding:10px; border-radius:10px; border:1px solid #ccc; }
    button { cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .hidden { display:none !important; }
    .tag { display:inline-block; padding:2px 10px; border:1px solid #ccc; border-radius:999px; font-size:12px; margin-left:8px; }
    .item { border:1px solid #eee; border-radius:12px; padding:12px; background:#fff; }
    .item h3 { margin:0 0 6px; font-size:16px; }
    .item small { display:block; margin-top:6px; }
    .admin { background:#fafafa; }
  </style>
</head>

<body>
  <header>
    <div>
      <h1 style="margin:0;">リンクINDEX</h1>
      <div class="muted">ログインした管理者のみリンクを閲覧・編集できます</div>
    </div>

    <!-- ログイン前はこの3つだけ見せる -->
    <div class="row">
      <button id="reloadBtn">再読み込み</button>
      <button id="loginBtn">管理者ログイン</button>
      <button id="logoutBtn" class="hidden">ログアウト</button>
    </div>
  </header>

  <!-- ログイン前メッセージ -->
  <section id="lockedCard" class="card">
    <strong>表示はロックされています。</strong>
    <div class="muted" style="margin-top:6px;">右上の「管理者ログイン」からログインしてください。</div>
  </section>

  <!-- ログイン後に表示するUI群 -->
  <section id="authedControls" class="hidden">
    <section class="card">
      <div class="row">
        <input id="q" placeholder="検索（タイトル/パス）" />
        <select id="catFilter">
          <option value="">カテゴリ（すべて）</option>
        </select>
        <span class="muted">取得元:</span>
        <code id="sourceLabel"></code>
        <span class="muted">件数:</span>
        <strong id="countLabel">-</strong>
        <span class="muted">最終更新:</span>
        <span id="updatedLabel">-</span>
      </div>
      <div id="netWarn" class="muted hidden" style="margin-top:8px;"></div>
    </section>

    <section id="list" class="grid"></section>
  </section>

  <!-- 管理者パネル -->
  <section id="adminPanel" class="card admin hidden">
    <h2 style="margin:0 0 10px;">管理者パネル</h2>

    <div id="loginBox" class="grid">
      <div class="item">
        <h3>ログイン（メール/パスワード）</h3>
        <div class="row">
          <input id="email" type="email" placeholder="email" style="min-width:240px;">
          <input id="pass" type="password" placeholder="password" style="min-width:240px;">
          <button id="doLogin">ログイン</button>
        </div>
        <div id="authMsg" class="muted" style="margin-top:8px;"></div>
      </div>

      <div class="item">
        <h3>一括保存</h3>
        <div class="row">
          <button id="saveAllBtn" disabled>一括保存（ログイン後に有効）</button>
          <span id="saveAllMsg" class="muted"></span>
        </div>
        <small class="muted">表示中の全リンクの編集内容をまとめて保存します。</small>
      </div>
    </div>

    <div id="editorBox" class="hidden">
      <div class="row" style="margin-bottom:10px;">
        <span>ログイン中: <strong id="userLabel"></strong></span>
        <span class="muted">（編集内容はFirestoreに保存）</span>
      </div>
      <small class="muted">各項目の「保存」で即時反映されます。Firestoreがブロックされていると保存に失敗します。</small>
    </div>
  </section>

  <script type="module">
    /********************
     * 0) 設定
     ********************/
    const CFG = {
      github: {
        owner: "DrPotter2022",
        repo: "call-link-test",
        branch: "main",
        path: "", // 直下
        includeExt: [".html", ".pdf"],
        siteBaseUrl: "https://drpotter2022.github.io/call-link-test/"
      },
      firebase: {
        apiKey: "AIzaSyCJV2CDJl9NW6Qz3sbPd8nrV0zevzZam0I",
        authDomain: "index-6c554.firebaseapp.com",
        projectId: "index-6c554",
      },
      collection: "link_index_meta_v1"
    };

    /********************
     * 1) Firebase
     ********************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const app = initializeApp(CFG.firebase);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /********************
     * 2) 便利関数
     ********************/
    const el = (id) => document.getElementById(id);

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    function defaultTitleFromPath(p) {
      const name = p.split("/").pop() || p;
      return decodeURIComponent(name)
        .replace(/\.[^/.]+$/, "")
        .replace(/[_-]+/g, " ");
    }

    function buildUrl(filePath) {
      return CFG.github.siteBaseUrl.replace(/\/$/, "/") + filePath;
    }

    function shouldInclude(filePath) {
      return /\.(html|pdf)$/i.test(filePath.split(/[?#]/)[0]);
    }

    /********************
     * 3) GitHub API
     ********************/
    async function fetchGitHubTree() {
      const { owner, repo, branch, path } = CFG.github;

      const refRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/ref/heads/${branch}`);
      if (!refRes.ok) throw new Error("GitHub ref取得に失敗: " + refRes.status);
      const refJson = await refRes.json();

      const commitRes = await fetch(refJson.object.url);
      if (!commitRes.ok) throw new Error("GitHub commit取得に失敗: " + commitRes.status);
      const commitJson = await commitRes.json();
      const treeSha = commitJson.tree.sha;

      const treeRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/${treeSha}?recursive=1`);
      if (!treeRes.ok) throw new Error("GitHub tree取得に失敗: " + treeRes.status);
      const treeJson = await treeRes.json();

      const base = (path || "").replace(/\/$/, "");
      const prefix = base ? (base + "/") : "";

      return treeJson.tree
        .filter(x => x.type === "blob" && x.path.startsWith(prefix))
        .map(x => ({ path: x.path, size: x.size ?? null }));
    }

    /********************
     * 4) Firestore meta
     ********************/
    function metaDocId(filePath) {
      return filePath.replaceAll("/", "__");
    }

    // 読み込みは失敗しても表示を止めない
    async function loadMeta(filePath) {
      try {
        const ref = doc(db, CFG.collection, metaDocId(filePath));
        const snap = await getDoc(ref);
        return snap.exists() ? snap.data() : null;
      } catch (e) {
        console.warn("loadMeta failed:", filePath, e);
        // Firestoreが遮断されていても一覧表示は継続
        return null;
      }
    }

    // 保存は “失敗を通知” する（ここは握りつぶさない）
    async function saveMeta(filePath, meta) {
      const ref = doc(db, CFG.collection, metaDocId(filePath));
      await setDoc(ref, { ...meta, updatedAt: serverTimestamp(), path: filePath }, { merge: true });
    }

    /********************
     * 5) UI state
     ********************/
    const listEl = el("list");
    const qEl = el("q");
    const catFilterEl = el("catFilter");
    const reloadBtn = el("reloadBtn");
    const loginBtn = el("loginBtn");
    const logoutBtn = el("logoutBtn");

    const lockedCard = el("lockedCard");
    const authedControls = el("authedControls");

    const adminPanel = el("adminPanel");
    const loginBox = el("loginBox");
    const editorBox = el("editorBox");
    const userLabel = el("userLabel");
    const saveAllBtn = el("saveAllBtn");
    const saveAllMsg = el("saveAllMsg");
    const netWarn = el("netWarn");

    el("sourceLabel").textContent = `github:${CFG.github.owner}/${CFG.github.repo}/${CFG.github.branch}/${CFG.github.path}`;

    let isAdmin = false;
    let items = [];

    function upsertCategoryOptions(categories) {
      const current = catFilterEl.value;
      catFilterEl.innerHTML = `<option value="">カテゴリ（すべて）</option>` +
        [...categories].sort().map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
      catFilterEl.value = current;
    }

    function applyFiltersAndRender() {
      const q = (qEl.value || "").trim().toLowerCase();
      const cat = catFilterEl.value;

      const filtered = items
        .filter(x => !x.hidden)
        .filter(x => !q || (x.title.toLowerCase().includes(q) || x.path.toLowerCase().includes(q)))
        .filter(x => !cat || x.category === cat)
        .sort((a,b) => (a.order ?? 9999) - (b.order ?? 9999) || a.title.localeCompare(b.title,"ja"));

      el("countLabel").textContent = String(filtered.length);
      listEl.innerHTML = filtered.map(x => renderItemCard(x)).join("");
      if (isAdmin) bindAdminControls();
    }

    function renderItemCard(x) {
      const tag = x.category ? `<span class="tag">${escapeHtml(x.category)}</span>` : "";
      const adminControls = isAdmin ? `
        <div class="row" style="margin-top:10px;">
          <input data-k="title" data-path="${escapeHtml(x.path)}" value="${escapeHtml(x.title)}" placeholder="表示名" style="min-width:220px;">
          <input data-k="category" data-path="${escapeHtml(x.path)}" value="${escapeHtml(x.category ?? "")}" placeholder="カテゴリ" style="min-width:160px;">
          <input data-k="order" data-path="${escapeHtml(x.path)}" value="${escapeHtml(x.order ?? "")}" placeholder="表示順(数字)" style="width:140px;">
          <label class="row" style="gap:6px;">
            <input type="checkbox" data-k="hidden" data-path="${escapeHtml(x.path)}" ${x.hidden ? "checked":""}>
            非表示
          </label>
          <button data-act="save" data-path="${escapeHtml(x.path)}">保存</button>
        </div>
      ` : "";

      return `
        <div class="item">
          <h3>
            <a href="${escapeHtml(x.url)}" target="_blank" rel="noopener">${escapeHtml(x.title)}</a>
            ${tag}
          </h3>
          <small class="muted">${escapeHtml(x.path)}</small>
          ${adminControls}
        </div>
      `;
    }

    async function rebuildCategoryList() {
      const cats = new Set();
      items.forEach(x => { if (x.category) cats.add(x.category); });
      upsertCategoryOptions(cats);
    }

    /********************
     * 6) 保存処理の共通化
     ********************/
    function readMetaFromCard(cardEl) {
      const path = cardEl.querySelector(`input[data-k="title"]`)?.getAttribute("data-path");
      if (!path) return null;

      const title = cardEl.querySelector(`input[data-k="title"]`)?.value.trim() ?? "";
      const category = cardEl.querySelector(`input[data-k="category"]`)?.value.trim() ?? "";
      const orderRaw = cardEl.querySelector(`input[data-k="order"]`)?.value.trim() ?? "";
      const hidden = cardEl.querySelector(`input[type="checkbox"][data-k="hidden"]`)?.checked ?? false;

      const order = orderRaw === "" ? null : Number(orderRaw);
      if (orderRaw !== "" && Number.isNaN(order)) {
        throw new Error("表示順は数字で入力してください");
      }

      return {
        path,
        meta: {
          title: title || defaultTitleFromPath(path),
          category: category || null,
          order,
          hidden
        }
      };
    }

    async function persistOne(path, meta) {
      await saveMeta(path, meta);

      const idx = items.findIndex(x => x.path === path);
      if (idx >= 0) {
        items[idx].title = meta.title ?? items[idx].title;
        items[idx].category = meta.category ?? null;
        items[idx].order = meta.order ?? null;
        items[idx].hidden = !!meta.hidden;
      }
    }

    function bindAdminControls() {
      // 単体保存
      listEl.querySelectorAll('button[data-act="save"]').forEach(btn => {
        if (btn.dataset.bound) return;
        btn.dataset.bound = "1";

        btn.addEventListener("click", async () => {
          const wrap = btn.closest(".item");
          try {
            btn.disabled = true;
            btn.textContent = "保存中…";

            const data = readMetaFromCard(wrap);
            if (!data) throw new Error("保存対象を特定できません");
            await persistOne(data.path, data.meta);

            await rebuildCategoryList();
            applyFiltersAndRender();
            alert("保存しました");
          } catch (e) {
            console.error(e);
            alert("保存失敗:
" + (e?.message ?? e) + "\n\n※ Firestoreがブロックされている場合、保存できません。");
          } finally {
            btn.disabled = false;
            btn.textContent = "保存";
          }
        });
      });
    }

    async function saveAllVisible() {
      const cards = [...listEl.querySelectorAll(".item")];
      let ok = 0, ng = 0;

      saveAllBtn.disabled = true;
      saveAllMsg.textContent = "一括保存中…";

      for (const card of cards) {
        try {
          const data = readMetaFromCard(card);
          if (!data) { ng++; continue; }
          await persistOne(data.path, data.meta);
          ok++;
        } catch (e) {
          console.error(e);
          ng++;
        }
      }

      await rebuildCategoryList();
      applyFiltersAndRender();

      saveAllMsg.textContent = `完了：成功 ${ok} / 失敗 ${ng}`;
      saveAllBtn.disabled = false;

      if (ng > 0) {
        alert(`一括保存：成功 ${ok} / 失敗 ${ng}\n\n※ Firestoreがブロックされていると失敗します。`);
      } else {
        alert(`一括保存：全件保存しました（${ok}件）`);
      }
    }

    /********************
     * 7) 読み込み（ログイン後のみ）
     ********************/
    async function loadAll() {
      if (!isAdmin) return;

      el("updatedLabel").textContent = new Date().toLocaleString("ja-JP");
      listEl.innerHTML = `<div class="card">読み込み中…</div>`;

      const raw = await fetchGitHubTree();
      const files = raw.filter(x => shouldInclude(x.path));

      const merged = [];
      for (const f of files) {
        const meta = await loadMeta(f.path);
        merged.push({
          path: f.path,
          url: buildUrl(f.path),
          title: meta?.title ?? defaultTitleFromPath(f.path),
          category: meta?.category ?? null,
          order: meta?.order ?? null,
          hidden: meta?.hidden ?? false
        });
      }

      items = merged;
      await rebuildCategoryList();
      applyFiltersAndRender();
    }

    /********************
     * 8) Auth UI
     ********************/
    function setAuthedUI(user) {
      isAdmin = !!user;

      // ログイン前：コントロール類は隠す
      lockedCard.classList.toggle("hidden", isAdmin);
      authedControls.classList.toggle("hidden", !isAdmin);

      logoutBtn.classList.toggle("hidden", !isAdmin);
      saveAllBtn.disabled = !isAdmin;

      if (isAdmin) {
        loginBox.classList.add("hidden");
        editorBox.classList.remove("hidden");
        userLabel.textContent = user.email || "(unknown)";

        // Firestoreがブロックされていると保存できないので注意喚起
        netWarn.classList.remove("hidden");
        netWarn.textContent = "※ Firestoreがブロックされている環境では、保存が失敗します（広告ブロッカー等を一時的にOFFにしてください）。";
        loadAll().catch(e => {
          console.error(e);
          listEl.innerHTML = `<div class="card danger">読み込みエラー: ${escapeHtml(e?.message ?? e)}</div>`;
        });
      } else {
        loginBox.classList.remove("hidden");
        editorBox.classList.add("hidden");
        userLabel.textContent = "";
        items = [];
        listEl.innerHTML = "";
      }
    }

    loginBtn.addEventListener("click", () => {
      adminPanel.classList.remove("hidden");
      adminPanel.scrollIntoView({ behavior: "smooth", block: "start" });
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    el("doLogin").addEventListener("click", async () => {
      try {
        el("authMsg").textContent = "ログイン中…";
        await signInWithEmailAndPassword(auth, el("email").value, el("pass").value);
        el("authMsg").textContent = "";
      } catch (e) {
        el("authMsg").textContent = "ログイン失敗: " + (e?.message ?? e);
      }
    });

    saveAllBtn.addEventListener("click", async () => {
      if (!isAdmin) {
        alert("ログイン後に実行できます");
        return;
      }
      await saveAllVisible();
    });

    reloadBtn.addEventListener("click", () => {
      if (!isAdmin) {
        alert("ログイン後に表示されます。管理者ログインしてください。");
        return;
      }
      loadAll().catch(e => console.error(e));
    });

    qEl.addEventListener("input", applyFiltersAndRender);
    catFilterEl.addEventListener("change", applyFiltersAndRender);

    onAuthStateChanged(auth, (user) => setAuthedUI(user));
  </script>
</body>
</html>
