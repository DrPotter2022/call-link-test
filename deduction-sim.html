<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>生命保険料控除シミュレーター（列幅最適化＋未使用枠）</title>
<style>
:root{
  --line:#d9dee8;--ink:#111;--accent:#c00;
  --new-blue:#d8e9ff;--old-blue:#b7d1f1;
  --green:#dcf7e1;--new-pink:#ffe2eb;--old-pink:#f7c6d4;
}
body{margin:0;background:#f7f8fb;color:var(--ink);font-family:"Noto Sans JP",system-ui,sans-serif}
.wrap{max-width:1100px;margin:20px auto;padding:0 16px}
h1{font-size:1.2rem;margin:0 0 12px}
fieldset{border:1px solid var(--line);border-radius:10px;background:#fff;padding:12px;margin:12px 0}
legend{font-weight:700}
input[type=text]{width:200px;padding:6px 8px;border:1px solid var(--line);border-radius:6px;font-variant-numeric:tabular-nums}
.btn{padding:8px 14px;border-radius:8px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
.btn-ghost{padding:5px 10px;border:1px dashed #bbb;border-radius:8px;background:#fff;cursor:pointer}
.step{border:1px solid var(--line);background:#f6f7fb;border-radius:8px;padding:5px 8px;cursor:pointer}
.step:hover{background:#eef1f8}
.stepbox{display:flex;gap:4px;flex-wrap:wrap}
.rowwrap{display:flex;align-items:center;gap:6px}
.grid2{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.del{border:none;background:transparent;color:#b00;cursor:pointer;font-weight:700}

.tint-new-blue input{background:var(--new-blue)}
.tint-old-blue input{background:var(--old-blue)}
.tint-green input{background:var(--green)}
.tint-new-pink input{background:var(--new-pink)}
.tint-old-pink input{background:var(--old-pink)}

.calc-bar{display:flex;justify-content:center;gap:10px;margin:8px 0}
.calc-note{color:#666;font-size:.9em}

/* ②結果テーブル */
.res-wrap{overflow-x:auto} /* 念のため横スクロール保険 */
table.res{width:100%;border-collapse:collapse;table-layout:fixed}
table.res col.sys{width:78px}  /* 1列目をギュッと詰める */
table.res col.main{width:auto}
table.res td{border:1px solid var(--line);padding:0;vertical-align:middle}
table.res .sec{background:#eaf0ff;font-weight:700;padding:6px 10px}
.band{border-radius:6px}
.band-blue-n{background:var(--new-blue)}
.band-blue-o{background:var(--old-blue)}
.band-green{background:var(--green)}
.band-pink-n{background:var(--new-pink)}
.band-pink-o{background:var(--old-pink)}
/* セル：左ラベルを伸縮、数値は右に固定。右端切れ防止 */
.cell{display:flex;justify-content:space-between;align-items:center;gap:6px;padding:10px 8px;overflow:hidden}
.lab{display:flex;align-items:center;gap:6px;white-space:normal;word-break:keep-all;flex:1 1 auto;min-width:0}
.badge{border:2px solid var(--accent);border-radius:6px;padding:1px 6px;color:#c00;font-weight:700;background:#fff}
.val{font-variant-numeric:tabular-nums;font-weight:800;color:#111;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-align:right;flex:0 0 auto;min-width:84px}
.sysTag{display:flex;align-items:center;justify-content:center;font-weight:800;color:#000}
.totalBand{position:relative}
.totalBand::before{content:"";position:absolute;inset:0;border:3px solid #111;border-radius:10px;background:#fff}
.totalWrap{position:relative;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;gap:12px}
.totalWrap .sum{font-size:1.3rem;font-weight:900}

/* ③年収レンジ表 */
table.inc{width:100%;border-collapse:collapse;background:#fff;margin-top:6px}
table.inc th,table.inc td{border:1px solid var(--line);padding:8px 10px;text-align:right}
table.inc th{background:#f3f5fb;font-weight:800}
table.inc .hit{background:#ffe9e9}
table.inc .hit td{font-weight:900;color:#c00}
.small{color:#666}

/* ④ 未使用枠 */
table.unused{width:100%;border-collapse:collapse}
table.unused th,table.unused td{border:1px solid var(--line);padding:8px 10px}
table.unused th{background:#f3f5fb;text-align:left}
table.unused td:last-child{text-align:right}
.badge-new{display:inline-block;border-radius:6px;background:#111;color:#fff;padding:1px 6px;font-size:.8rem}
</style>
</head>
<body>
<div class="wrap">
  <h1>◆ 給与所得者の保険料控除申告書</h1>

  <!-- ① 入力 -->
  <fieldset>
    <legend>① 入力</legend>
    <div class="grid2" style="margin-bottom:10px">
      <div class="rowwrap">
        <b style="margin-right:8px">年収</b>
        <input id="income" type="text" value="6,000,000">
        <div class="stepbox">
          <button class="step" data-target="income" data-delta="-1000000">−1,000,000</button>
          <button class="step" data-target="income" data-delta="-100000">−100,000</button>
          <button class="step reset" data-target="income" data-reset="true">0</button>
          <button class="step" data-target="income" data-delta="100000">＋100,000</button>
          <button class="step" data-target="income" data-delta="1000000">＋1,000,000</button>
        </div>
      </div>
      <span>円</span>
    </div>

    <div><b>【新】一般（A）</b><div id="list-genNew" class="tint-new-blue"></div><button class="btn-ghost" data-add="genNew">＋証明書を追加</button></div><hr>
    <div><b>【旧】一般（B）</b><div id="list-genOld" class="tint-old-blue"></div><button class="btn-ghost" data-add="genOld">＋証明書を追加</button></div><hr>
    <div><b>介護医療（C｜新のみ）</b><div id="list-medNew" class="tint-green"></div><button class="btn-ghost" data-add="medNew">＋証明書を追加</button></div><hr>
    <div><b>【新】個人年金（D）</b><div id="list-annNew" class="tint-new-pink"></div><button class="btn-ghost" data-add="annNew">＋証明書を追加</button></div><hr>
    <div><b>【旧】個人年金（E）</b><div id="list-annOld" class="tint-old-pink"></div><button class="btn-ghost" data-add="annOld">＋証明書を追加</button></div>
  </fieldset>

  <div class="calc-bar">
    <button id="calc" class="btn">計算</button>
    <div class="calc-note">（A〜E合計セルもクリックで直接入力できます）</div>
  </div>

  <!-- ② 結果 -->
  <fieldset>
    <legend>② 結果</legend>
    <div class="res-wrap">
      <table class="res">
        <colgroup>
          <col class="sys"><col class="main"><col class="main"><col class="main">
        </colgroup>
        <tbody>
          <!-- 一般 -->
          <tr><td class="sec" colspan="4">一般生命保険料</td></tr>
          <tr>
            <td class="band-blue-n"><div class="cell"><div class="sysTag">新制度</div><span></span></div></td>
            <td class="band band-blue-n"><div class="cell"><div class="lab"><span class="badge">A</span> A合計</div><span id="A" class="val" data-edit="genNew">0</span></div></td>
            <td class="band band-blue-n"><div class="cell"><div class="lab"><span class="badge">①</span> 控除（新・上限40,000）</div><span id="one" class="val">0</span></div></td>
            <td class="band band-blue-n"><div class="cell"><div class="lab"><span class="badge">③</span> ①＋②（上限40,000）</div><span id="three" class="val">0</span></div></td>
          </tr>
          <tr>
            <td class="band-blue-o"><div class="cell"><div class="sysTag">旧制度</div><span></span></div></td>
            <td class="band band-blue-o"><div class="cell"><div class="lab"><span class="badge">B</span> B合計</div><span id="B" class="val" data-edit="genOld">0</span></div></td>
            <td class="band band-blue-o"><div class="cell"><div class="lab"><span class="badge">②</span> 控除（旧・上限50,000）</div><span id="two" class="val">0</span></div></td>
            <td class="band band-blue-o"><div class="cell"><div class="lab"><span class="badge">㋑</span> ②と③の大きい方</div><span id="ina" class="val">0</span></div></td>
          </tr>

          <!-- 介護医療 -->
          <tr><td class="sec" colspan="4">介護医療保険料</td></tr>
          <tr>
            <td class="band-green"><div class="cell"><div class="sysTag">新制度</div><span></span></div></td>
            <td class="band band-green"><div class="cell"><div class="lab"><span class="badge">C</span> C合計</div><span id="C" class="val" data-edit="medNew">0</span></div></td>
            <td class="band"><div class="cell"><span></span><span></span></div></td>
            <td class="band band-green"><div class="cell"><div class="lab"><span class="badge">㋺</span> 控除（上限40,000）</div><span id="inu" class="val">0</span></div></td>
          </tr>

          <!-- 個人年金 -->
          <tr><td class="sec" colspan="4">個人年金保険料</td></tr>
          <tr>
            <td class="band-pink-n"><div class="cell"><div class="sysTag">新制度</div><span></span></div></td>
            <td class="band band-pink-n"><div class="cell"><div class="lab"><span class="badge">D</span> D合計</div><span id="D" class="val" data-edit="annNew">0</span></div></td>
            <td class="band band-pink-n"><div class="cell"><div class="lab"><span class="badge">④</span> 控除（新・上限40,000）</div><span id="four" class="val">0</span></div></td>
            <td class="band band-pink-n"><div class="cell"><div class="lab"><span class="badge">⑥</span> ④＋⑤（上限40,000）</div><span id="six" class="val">0</span></div></td>
          </tr>
          <tr>
            <td class="band-pink-o"><div class="cell"><div class="sysTag">旧制度</div><span></span></div></td>
            <td class="band band-pink-o"><div class="cell"><div class="lab"><span class="badge">E</span> E合計</div><span id="E" class="val" data-edit="annOld">0</span></div></td>
            <td class="band band-pink-o"><div class="cell"><div class="lab"><span class="badge">⑤</span> 控除（旧・上限50,000）</div><span id="five" class="val">0</span></div></td>
            <td class="band band-pink-o"><div class="cell"><div class="lab"><span class="badge">㋩</span> ⑤と⑥の大きい方</div><span id="ino" class="val">0</span></div></td>
          </tr>

          <!-- 合計 -->
          <tr>
            <td class="totalBand" colspan="4">
              <div class="totalWrap">
                <div><b>生命保険料控除額（㋑＋㋺＋㋩）</b></div>
                <div id="kanaTotal" class="sum">0</div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </fieldset>

  <!-- ③ 年収レンジ別の控除効果 -->
  <fieldset>
    <legend>③ 年収レンジ別の控除効果</legend>
    <div class="small">※限界税率は国税の速算表の目安、住民税は一律10%として概算します。</div>
    <table id="incTable" class="inc"></table>
  </fieldset>

  <!-- ④ 未使用控除枠内訳（新制度のみ） -->
  <fieldset>
    <legend>④ 未使用控除枠内訳（新制度のみ）</legend>
    <div class="small">※新制度は保険料80,000円で控除40,000円に達します。残り年額＝max(0, 80,000 − 現在の年額)。</div>
    <table id="unusedTable" class="unused"></table>
  </fieldset>
</div>

<script>
/* ▼ユーティリティ */
const fmt = n => (Math.round(n||0)).toLocaleString('ja-JP');
const yen = s => { if(typeof s==='number') return s; return +String(s||'0').replace(/,/g,'').replace(/[^\d.-]/g,'')||0; };
document.addEventListener('input',e=>{
  if(e.target.matches('input[type=text]')) e.target.value = fmt(yen(e.target.value));
});

/* 行追加・ステップ・削除 */
function stepGroup(){return `
  <div class="stepbox">
    <button class="step" data-delta="-10000">−10,000</button>
    <button class="step" data-delta="-1000">−1,000</button>
    <button class="step reset" data-reset="true">0</button>
    <button class="step" data-delta="1000">＋1,000</button>
    <button class="step" data-delta="10000">＋10,000</button>
  </div>`;}
function addRow(bucket){
  const host=document.getElementById('list-'+bucket);
  const row=document.createElement('div');
  row.className='grid2';
  row.innerHTML=`<div class="rowwrap"><input type="text" value="0">${stepGroup()}</div><button class="del">✕</button>`;
  host.appendChild(row);
}
['genNew','genOld','medNew','annNew','annOld'].forEach(addRow);

document.addEventListener('click',e=>{
  if(e.target.dataset.add){ addRow(e.target.dataset.add); fill(); return; }
  if(e.target.classList.contains('del')){ e.target.closest('.grid2')?.remove(); fill(); return; }
  const btn=e.target.closest('.step'); if(!btn) return;
  const inp=e.target.closest('.rowwrap')?.querySelector('input'); if(!inp) return;
  if(btn.dataset.reset){ inp.value='0'; fill(); return; }
  inp.value=fmt(Math.max(0, yen(inp.value)+(+btn.dataset.delta||0))); fill();
});

/* A〜E合計セルをクリックで直接入力 */
document.addEventListener('click',e=>{
  const t=e.target.closest('[data-edit]'); if(!t) return;
  const bucket=t.dataset.edit;
  const cur=sum(bucket);
  const v=window.prompt('この区分の合計額を入力', fmt(cur));
  if(v==null) return;
  const n=yen(v);
  const inputs=[...document.querySelectorAll('#list-'+bucket+' input')];
  if(inputs.length===0) addRow(bucket);
  const all=[...document.querySelectorAll('#list-'+bucket+' input')];
  all[0].value=fmt(n);
  for(let i=1;i<all.length;i++) all[i].value='0';
  fill();
});

/* ▼控除計算式 */
function newSys(x){ if(x<=20000)return x; if(x<=40000)return x/2+10000; if(x<=80000)return x/4+20000; return 40000; }
function oldSys(x){ if(x<=25000)return x; if(x<=50000)return x/2+12500; if(x<=100000)return x/4+25000; return 50000; }
function sum(bucket){ let t=0; document.querySelectorAll('#list-'+bucket+' input').forEach(i=>t+=yen(i.value)); return t; }

/* 計算本体 */
function compute(){
  const A=sum('genNew'), B=sum('genOld'), C=sum('medNew'), D=sum('annNew'), E=sum('annOld');

  // 所得税側（国税）控除額
  const one   = Math.min(40000, newSys(A));     // ①（新 一般）
  const two   = Math.min(50000, oldSys(B));     // ②（旧 一般）
  const three = Math.min(40000, one+two);       // ③
  const medI  = Math.min(40000, newSys(C));     // 介護医療（所得税）
  const four  = Math.min(40000, newSys(D));     // ④（新 年金）
  const five  = Math.min(50000, oldSys(E));     // ⑤（旧 年金）
  const six   = Math.min(40000, four+five);     // ⑥

  // 住民税側
  const ina   = Math.max(two, three);           // ㋑
  const inu   = medI;                           // ㋺
  const ino   = Math.max(five, six);            // ㋩

  const totalResident = ina + inu + ino;        // 住民税控除合計（黒枠）
  const totalIncome   = three + medI + six;     // 所得税控除合計（レンジ表用）

  return {A,B,C,D,E,one,two,three,medI,four,five,six,ina,inu,ino,totalResident,totalIncome};
}

/* ②反映 */
function fill(){
  const r=compute(), set=(id,v)=>{const el=document.getElementById(id); if(el) el.textContent=fmt(v);};
  set('A',r.A); set('B',r.B); set('C',r.C); set('D',r.D); set('E',r.E);
  set('one',r.one); set('two',r.two); set('three',r.three);
  set('inu',r.inu); set('four',r.four); set('five',r.five); set('six',r.six);
  set('ina',r.ina); set('ino',r.ino);
  document.getElementById('kanaTotal').textContent=fmt(r.totalResident);
  buildIncomeTable(r);     // ③
  buildUnusedTable(r);     // ④
}

/* ▼③ 年収レンジ別の控除効果 */
function marginalRate(annual){
  const y = annual;
  if(y <= 1950000) return 0.05;
  if(y <= 3300000) return 0.10;
  if(y <= 6950000) return 0.20;
  if(y <= 9000000) return 0.23;
  if(y <= 18000000) return 0.33;
  if(y <= 40000000) return 0.40;
  return 0.45;
}
function buildIncomeTable(r){
  const host=document.getElementById('incTable');
  const base=yen(document.getElementById('income').value)||0;
  const incomes=[]; for(let v=2000000; v<=12000000; v+=1000000) incomes.push(v);
  let html = '<tr><th>年収</th><th>限界税率</th><th>控除額（所得税）</th><th>控除額（住民税）</th><th>合計軽減額</th></tr>';
  incomes.forEach(v=>{
    const rate = marginalRate(v);
    const incomeSave   = r.totalIncome   * rate;
    const residentSave = r.totalResident * 0.10;
    const total = incomeSave + residentSave;
    const hit = (Math.abs(v - base) < 500000) ? ' class="hit"' : '';
    html += `<tr${hit}>
      <td>${fmt(v)}</td>
      <td>${Math.round(rate*100)}%</td>
      <td>${fmt(incomeSave)}</td>
      <td>${fmt(residentSave)}</td>
      <td>${fmt(total)}</td>
    </tr>`;
  });
  host.innerHTML = html;
}

/* ▼④ 未使用控除枠（新制度のみ：A,C,D） */
function unusedPremiumRemain(currentAnnual){
  // 新制度で控除満額(40,000)になるのは保険料80,000円。そこまでの残り年額。
  return Math.max(0, 80000 - currentAnnual);
}
function buildUnusedTable(r){
  const rows = [
    {label:'一般生命保険料（新制度）', amt:r.A,  color:'var(--new-blue)'},
    {label:'介護医療保険料（新制度）', amt:r.C,  color:'var(--green)'},
    {label:'個人年金保険料（新制度）', amt:r.D,  color:'var(--new-pink)'}
  ];
  let html = '<tr><th>区分</th><th>現在の年額</th><th>未使用枠（年額）</th><th>未使用枠（月額目安）</th></tr>';
  rows.forEach(x=>{
    const remain = unusedPremiumRemain(x.amt);
    html += `<tr>
      <td><span class="badge-new">新</span> ${x.label}</td>
      <td>${fmt(x.amt)}</td>
      <td>${fmt(remain)}</td>
      <td>${fmt(remain/12)}</td>
    </tr>`;
  });
  document.getElementById('unusedTable').innerHTML = html;
}

/* ボタン */
document.getElementById('calc').addEventListener('click',fill);

/* 初期描画 */
fill();
</script>
</body>
</html>
