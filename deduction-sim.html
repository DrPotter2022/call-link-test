<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>生命保険料控除シミュレーター（リセット＆配色連動・中列拡張）</title>
<style>
:root{
  --line:#d9dee8;--ink:#111;--muted:#667085;--accent:#c00;--bg:#f7f8fb;
  --new-blue:#d8e9ff;--old-blue:#b7d1f1;--green:#dcf7e1;
  --new-pink:#ffe2eb;--old-pink:#f7c6d4;
}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Sans JP",system-ui,-apple-system,sans-serif}
.wrap{max-width:1100px;margin:22px auto;padding:0 16px}
h1{font-size:1.12rem;margin:0 0 10px}
fieldset{border:1px solid var(--line);border-radius:12px;background:#fff;padding:12px;margin:12px 0}
legend{font-weight:700}
.card{border:1px solid var(--line);border-radius:10px;padding:10px;margin:8px 0;background:#fff}
.grid2{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
input[type=text]{width:220px;padding:8px;border:1px solid var(--line);border-radius:8px;font-variant-numeric:tabular-nums}
.btn{padding:10px 16px;border:1px solid #111;border-radius:10px;background:#111;color:#fff;cursor:pointer}
.btn-ghost{padding:6px 10px;border:1px dashed #bbb;border-radius:8px;background:#fff;cursor:pointer}
.del{border:none;background:transparent;color:#b00;cursor:pointer;font-weight:700}
.small{color:var(--muted);font-size:.9em}
.mono{font-variant-numeric:tabular-nums}

/* 入力ステッパー（±＋リセット） */
.rowwrap{display:flex;align-items:center;gap:8px}
.stepbox{display:flex;gap:4px;flex-wrap:wrap}
.step{border:1px solid var(--line);background:#f6f7fb;border-radius:8px;padding:6px 8px;cursor:pointer;font-size:.85rem}
.step:hover{background:#eef1f8}
.step.strong{font-weight:700}
.step.reset{background:#fff;border-style:dashed}
.del{margin-left:4px}

/* 入力ボックスの配色連動 */
.tint-new-blue input{background:var(--new-blue)}
.tint-old-blue input{background:var(--old-blue)}
.tint-green    input{background:var(--green)}
.tint-new-pink input{background:var(--new-pink)}
.tint-old-pink input{background:var(--old-pink)}

/* ①と②の間の計算ボタン */
.calc-bar{display:flex;justify-content:center;align-items:center;gap:12px;margin:6px 0 12px}
.calc-main{font-size:1rem;padding:12px 22px;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.calc-note{color:#667085;font-size:.92em}

/* ②結果テーブル（横バンド・可変高さ） */
#strict table.rt{width:100%;border-collapse:collapse;table-layout:fixed;background:#fff;border:1px solid var(--line)}
#strict td{border:1px solid var(--line);padding:0;vertical-align:middle}
#strict .sec{background:#eaf0ff;font-weight:800;padding:8px 12px}
/* ← 中列幅を拡張（28% → 36%）、右列は 22%へ */
#strict col.sys{width:9rem}
#strict col.l{width:42%}
#strict col.m{width:36%}
#strict col.r{width:22%}
#strict .syscell{background:#fbfcff;text-align:center;font-weight:700}
.sysTag{color:#c00;font-weight:800}

/* 横バンド */
.band{position:relative}
.band::before{content:"";position:absolute;inset:0;border-radius:4px}
.band .cell{
  position:relative;display:grid;grid-template-columns:auto 1fr 200px; /* ← 数値領域を 200px に拡大 */
  gap:10px;align-items:flex-start;padding:12px 12px;line-height:1.35;word-break:keep-all;
}
.badge{display:inline-block;border:2px solid var(--accent);border-radius:6px;padding:2px 6px;font-weight:700;color:#c00}
.lab{display:flex;align-items:center;gap:8px;white-space:nowrap}
.val{text-align:right;font-variant-numeric:tabular-nums;cursor:pointer;align-self:center}

/* バンド色 */
.band-blue-n::before{background:var(--new-blue)}
.band-blue-o::before{background:var(--old-blue)}
.band-green::before{background:var(--green)}
.band-pink-n::before{background:var(--new-pink)}
.band-pink-o::before{background:var(--old-pink)}

/* 合計行（ラベル左／金額右） */
.totalRow td{border-width:2px}
.totalBand{position:relative}
.totalBand::before{content:"";position:absolute;inset:0;border:3px solid #111;border-radius:10px;background:#fff}
.totalWrap{position:relative;display:grid;grid-template-columns:1fr auto;align-items:center;gap:12px;padding:14px 18px}
.totalWrap .label{font-weight:800}
.totalWrap .sum{font-size:1.4rem;font-weight:900;text-align:right}

/* ③レンジ表 */
#range{width:100%;border-collapse:collapse;background:#fff}
#range th,#range td{border:1px solid var(--line);padding:8px;text-align:right}
#range th{background:#f2f5fb;text-align:left}
#range td:first-child{text-align:left}
tr.highlight{background:#ffecec}
tr.highlight td:nth-child(5),tr.highlight td:nth-child(6),tr.highlight td:nth-child(7){color:#d00;font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <h1>◆ 給与所得者の保険料控除申告書（リセット＆配色連動・中列拡張）</h1>

  <!-- ① 入力 -->
  <fieldset>
    <legend>① 入力（複数の控除証明書を合算）</legend>
    <div class="card"><b>年収</b>
      <div class="grid2">
        <div class="rowwrap">
          <input id="income" type="text" class="mono" value="6,000,000">
          <div class="stepbox">
            <button class="step" data-target="income" data-delta="-10000">−10,000</button>
            <button class="step" data-target="income" data-delta="-1000">−1,000</button>
            <button class="step reset" data-target="income" data-reset="true">0</button>
            <button class="step strong" data-target="income" data-delta="1000">＋1,000</button>
            <button class="step strong" data-target="income" data-delta="10000">＋10,000</button>
          </div>
        </div>
        <span>円</span>
      </div>
    </div>

    <!-- A～E：入力ボックスを配色連動でラップ -->
    <div class="card"><b>【新】一般（A）</b>
      <div id="list-genNew" class="tint-new-blue"></div>
      <button class="btn-ghost" data-add="genNew">＋証明書を追加</button>
    </div>

    <div class="card"><b>【旧】一般（B）</b>
      <div id="list-genOld" class="tint-old-blue"></div>
      <button class="btn-ghost" data-add="genOld">＋証明書を追加</button>
    </div>

    <div class="card"><b>介護医療（C｜新のみ）</b>
      <div id="list-medNew" class="tint-green"></div>
      <button class="btn-ghost" data-add="medNew">＋証明書を追加</button>
    </div>

    <div class="card"><b>【新】個人年金（D）</b>
      <div id="list-annNew" class="tint-new-pink"></div>
      <button class="btn-ghost" data-add="annNew">＋証明書を追加</button>
    </div>

    <div class="card"><b>【旧】個人年金（E）</b>
      <div id="list-annOld" class="tint-old-pink"></div>
      <button class="btn-ghost" data-add="annOld">＋証明書を追加</button>
    </div>

    <div class="small">※各行の「−10,000 / −1,000 / 0 / ＋1,000 / ＋10,000」ボタンでクリックだけで調整できます。</div>
  </fieldset>

  <!-- ①と②の間の「計算」 -->
  <div class="calc-bar">
    <button id="calc" class="btn calc-main">計算</button>
    <div class="calc-note">（結果の合計セルもクリックで直接入力できます）</div>
  </div>

  <!-- ② 結果 -->
  <fieldset id="strict">
    <legend>② 結果（クリックで入力）</legend>
    <table class="rt">
      <colgroup><col class="sys"><col class="l"><col class="m"><col class="r"></colgroup>
      <tbody>
        <!-- 一般生命保険料 -->
        <tr><td class="sec" colspan="4">一般生命保険料</td></tr>
        <tr>
          <td class="syscell band band-blue-n"><div class="cell"><div class="lab"><span class="sysTag">新制度</span></div><div></div><div></div></div></td>
          <td class="band band-blue-n"><div class="cell"><div class="lab"><span class="badge">A</span>A 合計</div><div id="A" class="val" data-edit="genNew">0</div></div></td>
          <td class="band band-blue-n"><div class="cell"><div class="lab"><span class="badge">①</span>控除（新・上限40,000）</div><div id="one" class="val">0</div></div></td>
          <td class="band band-blue-n"><div class="cell"><div class="lab"><span class="badge">③</span>①＋②（上限40,000）</div><div id="three" class="val">0</div></div></td>
        </tr>
        <tr>
          <td class="syscell band band-blue-o"><div class="cell"><div class="lab"><span class="sysTag">旧制度</span></div><div></div><div></div></div></td>
          <td class="band band-blue-o"><div class="cell"><div class="lab"><span class="badge">B</span>B 合計</div><div id="B" class="val" data-edit="genOld">0</div></div></td>
          <td class="band band-blue-o"><div class="cell"><div class="lab"><span class="badge">②</span>控除（旧・上限50,000）</div><div id="two" class="val">0</div></div></td>
          <td class="band band-blue-o"><div class="cell"><div class="lab"><span class="badge">㋑</span>②と③の大きい方</div><div id="ina" class="val">0</div></div></td>
        </tr>

        <!-- 介護医療保険料 -->
        <tr><td class="sec" colspan="4">介護医療保険料</td></tr>
        <tr>
          <td class="syscell band band-green"><div class="cell"><div class="lab"><span class="sysTag">新制度</span></div><div></div><div></div></div></td>
          <td class="band band-green"><div class="cell"><div class="lab"><span class="badge">C</span>C 合計</div><div id="C" class="val" data-edit="medNew">0</div></div></td>
          <td class="band"><div class="cell"><div class="lab"></div><div class="val"></div></div></td>
          <td class="band band-green"><div class="cell"><div class="lab"><span class="badge">㋺</span>控除（上限40,000）</div><div id="inu" class="val">0</div></div></td>
        </tr>

        <!-- 個人年金保険料 -->
        <tr><td class="sec" colspan="4">個人年金保険料</td></tr>
        <tr>
          <td class="syscell band band-pink-n"><div class="cell"><div class="lab"><span class="sysTag">新制度</span></div><div></div><div></div></div></td>
          <td class="band band-pink-n"><div class="cell"><div class="lab"><span class="badge">D</span>D 合計</div><div id="D" class="val" data-edit="annNew">0</div></div></td>
          <td class="band band-pink-n"><div class="cell"><div class="lab"><span class="badge">④</span>控除（新・上限40,000）</div><div id="four" class="val">0</div></div></td>
          <td class="band band-pink-n"><div class="cell"><div class="lab"><span class="badge">⑥</span>④＋⑤（上限40,000）</div><div id="six" class="val">0</div></div></td>
        </tr>
        <tr>
          <td class="syscell band band-pink-o"><div class="cell"><div class="lab"><span class="sysTag">旧制度</span></div><div></div><div></div></div></td>
          <td class="band band-pink-o"><div class="cell"><div class="lab"><span class="badge">E</span>E 合計</div><div id="E" class="val" data-edit="annOld">0</div></div></td>
          <td class="band band-pink-o"><div class="cell"><div class="lab"><span class="badge">⑤</span>控除（旧・上限50,000）</div><div id="five" class="val">0</div></div></td>
          <td class="band band-pink-o"><div class="cell"><div class="lab"><span class="badge">㋩</span>⑤と⑥の大きい方</div><div id="ino" class="val">0</div></div></td>
        </tr>

        <!-- 合計 -->
        <tr class="totalRow">
          <td class="totalBand" colspan="4">
            <div class="totalWrap">
              <div class="label">生命保険料控除額（㋑＋㋺＋㋩）</div>
              <div id="kanaTotal" class="sum">0</div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </fieldset>

  <!-- ③ 年収レンジ別の控除効果 -->
  <fieldset>
    <legend>③ 年収レンジ別の控除効果（入力年収の行をハイライト）</legend>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 10px">
      <div>起点 <input id="rStart" type="text" class="mono" value="3,000,000"> 円</div>
      <div>終点 <input id="rEnd" type="text" class="mono" value="12,000,000"> 円</div>
      <div>刻み <input id="rStep" type="text" class="mono" value="1,000,000"> 円</div>
      <button id="reRange" class="btn">レンジ再計算</button>
    </div>
    <table id="range">
      <thead><tr>
        <th>年収</th><th>限界税率（所得税）</th><th>控除額（所得税）</th>
        <th>控除額（住民税）</th><th>所得税の軽減</th><th>住民税の軽減</th><th>合計軽減</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </fieldset>
</div>

<script>
/* 数値フォーマット */
const fmt=n=>(Math.round(n||0)).toLocaleString('ja-JP');
const yen=s=>{if(typeof s==='number')return s;if(!s)return 0;return +String(s).replace(/,/g,'').replace(/[^\d.-]/g,'')||0};
document.addEventListener('input',e=>{if(e.target.matches('input[type=text]'))e.target.value=fmt(yen(e.target.value))});

/* ステッパー（±＋リセット） */
function adjustInputById(id,delta,reset=false){
  const el=document.getElementById(id);
  if(!el) return;
  const v = reset ? 0 : Math.max(0,yen(el.value)+delta);
  el.value=fmt(v);
}
document.addEventListener('click',e=>{
  const btn=e.target.closest('.step'); if(!btn) return;
  const targetId=btn.dataset.target;
  if(targetId){
    adjustInputById(targetId, +(btn.dataset.delta||0), !!btn.dataset.reset);
    return;
  }
  // 行内ステッパー
  const input=e.target.closest('.rowwrap')?.querySelector('input[type=text]');
  if(!input) return;
  if(btn.dataset.reset){ input.value='0'; return; }
  const v=Math.max(0,yen(input.value)+(+btn.dataset.delta||0));
  input.value=fmt(v);
});

/* 入力行の追加/削除（各行にステッパーを付与） */
document.addEventListener('click',e=>{
  if(e.target.dataset.add) addRow(e.target.dataset.add);
  if(e.target.classList.contains('del')) e.target.closest('.grid2')?.remove();
});
function stepGroupHTML(){
  return `
    <div class="stepbox">
      <button class="step" data-delta="-10000">−10,000</button>
      <button class="step" data-delta="-1000">−1,000</button>
      <button class="step reset" data-reset="true">0</button>
      <button class="step strong" data-delta="1000">＋1,000</button>
      <button class="step strong" data-delta="10000">＋10,000</button>
    </div>`;
}
function addRow(bucket){
  const host=document.getElementById('list-'+bucket);
  const row=document.createElement('div');
  row.className='grid2';
  row.innerHTML=`
    <div class="rowwrap">
      <input type="text" class="mono" value="0">
      ${stepGroupHTML()}
    </div>
    <button class="del" type="button">✕</button>`;
  host.appendChild(row);
}
/* 初期行 */
['genNew','genOld','medNew','annNew','annOld'].forEach(addRow);

/* 新旧の計算式 */
function newSys(x){if(x<=20000)return x; if(x<=40000)return x/2+10000; if(x<=80000)return x/4+20000; return 40000;}
function oldSys(x){if(x<=25000)return x; if(x<=50000)return x/2+12500; if(x<=100000)return x/4+25000; return 50000;}

/* 合算 */
function sum(bucket){let t=0; document.querySelectorAll('#list-'+bucket+' input').forEach(i=>t+=yen(i.value)); return t;}

/* 計算 */
function compute(){
  const A=sum('genNew'), B=sum('genOld'), C=sum('medNew'), D=sum('annNew'), E=sum('annOld');
  const one = Math.min(40000,newSys(A));     // ①
  const two = Math.min(50000,oldSys(B));     // ②
  const three = Math.min(40000,one+two);     // ③
  const ina = Math.max(two,three);           // ㋑
  const inu = Math.min(40000,newSys(C));     // ㋺
  const four = Math.min(40000,newSys(D));    // ④
  const five = Math.min(50000,oldSys(E));    // ⑤
  const six = Math.min(40000,four+five);     // ⑥
  const ino = Math.max(five,six);            // ㋩
  const kanaTotal = ina + inu + ino;         // 合計
  return {A,B,C,D,E,one,two,three,ina,inu,four,five,six,ino,kanaTotal};
}

/* 反映 */
function fill(){
  const r=compute(), set=(id,v)=>document.getElementById(id).textContent=fmt(v);
  ['A','B','C','D','E','one','two','three','ina','inu','four','five','six','ino'].forEach(k=>set(k,r[k]));
  document.getElementById('kanaTotal').textContent=fmt(r.kanaTotal);
  renderRange(r);
}
document.getElementById('calc').addEventListener('click',fill);

/* クリックだけで入力（A/B/C/D/E 合計セル） */
document.addEventListener('click',e=>{
  const t=e.target.closest('[data-edit]'); if(!t) return;
  const bucket=t.getAttribute('data-edit');
  const current=sum(bucket);
  const v=window.prompt('この区分の合計額を入力してください（半角数字・3桁区切り可）',fmt(current));
  if(v===null) return;
  const n=yen(v);
  const rows=[...document.querySelectorAll('#list-'+bucket+' input')];
  if(rows.length===0) addRow(bucket);
  const all=[...document.querySelectorAll('#list-'+bucket+' input')];
  if(all.length){all[0].value=fmt(n); for(let i=1;i<all.length;i++) all[i].value='0';}
  fill();
});

/* ③ 年収レンジ表 */
function salaryDeduction2024(s){
  if(s<=1625000)return 550000;
  if(s<=1800000)return s*0.4-100000;
  if(s<=3600000)return s*0.3+80000;
  if(s<=6600000)return s*0.2+440000;
  if(s<=8500000)return s*0.1+1100000;
  return 1950000;
}
function marginalIT(t){
  if(t<=1950000)return .05;
  if(t<=3300000)return .10;
  if(t<=6950000)return .20;
  if(t<=9000000)return .23;
  if(t<=18000000)return .33;
  if(t<=40000000)return .40;
  return .45;
}
function currentRates(inc){
  const sd=salaryDeduction2024(inc);
  const taxable=Math.max(0,inc-sd-480000);
  return {it:marginalIT(taxable),inh:.10};
}
function renderRange(r){
  const itDed = r.three + r.inu + r.four;
  const inhDed = r.ina + r.inu + r.ino;
  const s=yen(document.getElementById('rStart').value)||3000000;
  const e=yen(document.getElementById('rEnd').value)||12000000;
  const st=Math.max(1,yen(document.getElementById('rStep').value)||1000000);
  const cur=yen(document.getElementById('income').value)||0;
  const tb=document.querySelector('#range tbody'); tb.innerHTML='';
  for(let inc=s;inc<=e;inc+=st){
    const rate=currentRates(inc);
    const itSave=itDed*rate.it, inhSave=inhDed*rate.inh, total=itSave+inhSave;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(inc)}</td><td>${(rate.it*100).toFixed(0)}%</td>
                  <td>${fmt(itDed)}</td><td>${fmt(inhDed)}</td>
                  <td>${fmt(itSave)}</td><td>${fmt(inhSave)}</td><td>${fmt(total)}</td>`;
    if(inc===cur) tr.classList.add('highlight');
    tb.appendChild(tr);
  }
}
document.getElementById('reRange').addEventListener('click',()=>renderRange(compute()));

/* 初期表示 */
fill();
</script>
</body>
</html>
